<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RiderSkill — Accueil</title>
<link rel="icon" href="https://unavatar.io/twitch/riderskill" />
<meta name="theme-color" content="#0D0D0D" />

<!-- Sécurité navigateur -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               img-src 'self' https://unavatar.io https://cdn.simpleicons.org https://images.unsplash.com https://cdn.pixabay.com data:;
               script-src 'self' https://player.twitch.tv 'unsafe-inline';
               style-src 'self' 'unsafe-inline';
               frame-src https://player.twitch.tv https://www.twitch.tv;
               connect-src 'self';
               media-src 'self' https://riderskill.github.io;
               object-src 'none';
               base-uri 'self';
               form-action 'none';
               upgrade-insecure-requests;">
<meta http-equiv="Permissions-Policy"
      content="autoplay=(), camera=(), microphone=(), geolocation=(), usb=(), payment=()">
<meta name="referrer" content="no-referrer">

<style>
/* ton CSS existant (raccourci ici pour l’exemple) */
body {
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  color:#EDEDED;
  background: url("/riderskill-site/musique/bg.jpg") center/cover no-repeat fixed;
}
</style>
</head>
<body>
  <div class="topbar">…</div>

  <section class="section container" id="live">
    <div class="panel">
      <h2>Live intégré</h2>
      <div class="live-wrap">
        <div id="twitch-player" class="player"></div>
        <iframe id="twitch-chat" class="chat"
                src="https://www.twitch.tv/embed/riderskill/chat?parent=riderskill.github.io"
                allowfullscreen></iframe>
      </div>
    </div>
  </section>

  <section class="section container" id="agenda">
    <div class="panel">
      <h2>Agenda</h2>
      <div id="agendaList" class="agenda-list"></div>
    </div>
  </section>

  <footer class="container">© 2025 RiderSkill</footer>

<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script>
/* Fonction d’échappement pour éviter XSS */
function esc(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}

/* Status LIVE/OFF */
function setStatus(state){
  const dot=document.getElementById('statusDot');
  const label=document.getElementById('statusLabel');
  if(!dot||!label) return;
  if(state==='on'){
    dot.style.background='#22c55e';
    label.textContent='LIVE'; label.style.color='#22c55e';
  } else {
    dot.style.background='#ef4444';
    label.textContent='OFF'; label.style.color='#ef4444';
  }
}
setStatus('off');

/* Twitch Player */
(function(){
  const parentHosts=["riderskill.github.io"];
  const player=new Twitch.Player("twitch-player",{
    channel:"riderskill",width:"100%",height:"100%",autoplay:true,muted:true,parent:parentHosts
  });
  player.addEventListener(Twitch.Player.ONLINE,()=>setStatus('on'));
  player.addEventListener(Twitch.Player.OFFLINE,()=>setStatus('off'));
})();

/* Agenda sécurisé */
function fmtDate(d){return d.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'2-digit'})}
function fmtTime(d){return d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
function renderAgenda(items){
  const el=document.getElementById('agendaList'); if(!el) return;
  const now=new Date();
  el.innerHTML = (Array.isArray(items)?items:[]).map(it=>{
    const s=new Date(it.start); const e=it.end?new Date(it.end):null;
    const live=s<=now && (!e||e>=now);
    const soon=s>now && (s-now)<=1000*60*60*6;
    const badge= live?'live':(soon?'soon':'off');
    const text= live?'EN LIVE':(soon?'Bientôt':'Programmé');
    return `<div class="ag-item"><div class="ag-left">
      <h3 class="ag-title">${esc(it.title||'Live')}</h3>
      <div class="ag-meta">${fmtDate(s)} · ${fmtTime(s)}${e?(' → '+fmtTime(e)):""} · ${esc(it.platform||'')}</div>
    </div><span class="badge ${badge}">${text}</span></div>`;
  }).join('');
}
fetch('/riderskill-site/planning.json',{cache:'no-store'})
  .then(r=>r.json())
  .then(renderAgenda)
  .catch(()=>{});
</script>
</body>
</html>
